<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLM Trainer - Map Viewer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Consolas', 'Courier New', monospace; background: #1a1a2e; color: #e0e0e0; padding: 16px; }
  h1 { color: #00d4ff; margin-bottom: 12px; font-size: 1.4em; }
  h2 { color: #ffd700; margin: 12px 0 8px; font-size: 1.1em; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }

  .card {
    background: #16213e; border: 1px solid #0f3460; border-radius: 8px;
    padding: 12px; overflow: auto;
  }

  .status-row { display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 8px; }
  .status-item { display: flex; gap: 6px; }
  .status-label { color: #888; }
  .status-value { color: #00d4ff; font-weight: bold; }

  #map-select { background: #0f3460; color: #e0e0e0; border: 1px solid #00d4ff; padding: 4px 8px; border-radius: 4px; margin-bottom: 8px; }

  .map-grid { font-size: 11px; line-height: 1.1; white-space: pre; font-family: monospace; }
  .tile-W { color: #4caf50; }
  .tile-N { color: #f44336; }
  .tile-P { color: #ffeb3b; font-weight: bold; }
  .tile-T { color: #e040fb; }
  .tile-L { color: #ff9800; }
  .tile-I { color: #03a9f4; }
  .tile-unknown { color: #555; }

  .decisions-list { max-height: 400px; overflow-y: auto; }
  .decision-entry {
    padding: 4px 8px; border-bottom: 1px solid #0f3460; font-size: 0.85em;
  }
  .decision-entry.success { border-left: 3px solid #4caf50; }
  .decision-entry.failure { border-left: 3px solid #f44336; }
  .decision-action { color: #00d4ff; font-weight: bold; }
  .decision-outcome { color: #888; }

  .refresh-info { color: #555; font-size: 0.8em; margin-top: 8px; }
  .connections-list { font-size: 0.85em; }
  .conn-entry { padding: 2px 0; color: #e040fb; }
</style>
</head>
<body>

<h1>LLM Trainer - Live Dashboard</h1>

<div class="status-row" id="status">
  <div class="status-item"><span class="status-label">Status:</span><span class="status-value" id="s-status">Loading...</span></div>
  <div class="status-item"><span class="status-label">Map:</span><span class="status-value" id="s-map">-</span></div>
  <div class="status-item"><span class="status-label">Position:</span><span class="status-value" id="s-pos">-</span></div>
  <div class="status-item"><span class="status-label">Facing:</span><span class="status-value" id="s-facing">-</span></div>
  <div class="status-item"><span class="status-label">Decisions:</span><span class="status-value" id="s-decisions">0</span></div>
  <div class="status-item"><span class="status-label">Strategy:</span><span class="status-value" id="s-strategy">-</span></div>
</div>

<div class="grid">
  <div class="card">
    <h2>Traversal Map</h2>
    <select id="map-select"><option value="">Loading maps...</option></select>
    <div class="map-grid" id="traversal-map">Loading...</div>
  </div>

  <div class="card">
    <h2>Recent Decisions</h2>
    <div class="decisions-list" id="decisions-list">Loading...</div>
  </div>

  <div class="card">
    <h2>Tile Map</h2>
    <div class="map-grid" id="tile-map" style="font-size:9px;">Loading...</div>
  </div>

  <div class="card">
    <h2>Map Connections</h2>
    <div class="connections-list" id="connections-list">Loading...</div>
  </div>
</div>

<div class="refresh-info">Auto-refreshes every 2 seconds</div>

<script>
const POLL_MS = 2000;
let currentMapKey = null;

async function fetchJSON(url) {
  try { const r = await fetch(url); return r.ok ? await r.json() : null; }
  catch { return null; }
}

function renderTraversalMap(mapData) {
  if (!mapData || !mapData.traversal_map) return 'No data';
  const trav = mapData.traversal_map;
  let html = '';
  for (let y = 0; y < trav.length; y++) {
    for (let x = 0; x < trav[y].length; x++) {
      const m = trav[y][x];
      const cls = m === '?' ? 'unknown' : `tile-${m}`;
      html += `<span class="${cls}">${m}</span>`;
    }
    html += '\n';
  }
  return html;
}

function renderTileMap(mapData) {
  if (!mapData || !mapData.tile_map) return 'No data';
  const tm = mapData.tile_map;
  let html = '';
  for (let y = 0; y < tm.length; y++) {
    const row = [];
    for (let x = 0; x < tm[y].length; x++) {
      const t = tm[y][x];
      const short = t === 'unknown' ? '.' : t.substring(0, 3);
      row.push(short.padEnd(4));
    }
    html += row.join('') + '\n';
  }
  return html;
}

function renderDecisions(decisions) {
  if (!decisions || decisions.length === 0) return '<div class="decision-entry">No decisions yet</div>';
  return decisions.slice().reverse().map(d => {
    const cls = d.outcome_success ? 'success' : 'failure';
    return `<div class="decision-entry ${cls}">
      <span class="decision-action">#${d.number} ${d.action}</span>
      <span class="decision-outcome">${d.outcome_type} | ${d.map} (${d.position?.x},${d.position?.y}) ${d.facing}</span>
      <div style="color:#666;font-size:0.85em">${d.reasoning || ''}</div>
    </div>`;
  }).join('');
}

function renderConnections(connections) {
  if (!connections || Object.keys(connections).length === 0) return 'No connections yet';
  let html = '';
  for (const [mapKey, conns] of Object.entries(connections)) {
    for (const c of conns) {
      html += `<div class="conn-entry">${c.from_map} (${c.from_tile[0]},${c.from_tile[1]}) â†’ ${c.to_map} (${c.to_tile[0]},${c.to_tile[1]}) [${c.direction}]</div>`;
    }
  }
  return html;
}

async function refresh() {
  const status = await fetchJSON('/llm/status');
  if (status) {
    document.getElementById('s-status').textContent = status.enabled ? 'Active' : 'Inactive';
    document.getElementById('s-map').textContent = status.map || '-';
    document.getElementById('s-pos').textContent = status.position ? `(${status.position.x}, ${status.position.y})` : '-';
    document.getElementById('s-facing').textContent = status.facing || '-';
    document.getElementById('s-decisions').textContent = status.total_decisions;
    document.getElementById('s-strategy').textContent = status.agent_strategy || '-';
    if (status.map_key && status.map_key !== currentMapKey) {
      currentMapKey = status.map_key;
      document.getElementById('map-select').value = currentMapKey;
    }
  }

  const decisions = await fetchJSON('/llm/decisions');
  if (decisions) {
    document.getElementById('decisions-list').innerHTML = renderDecisions(decisions);
  }

  // Load map list
  const maps = await fetchJSON('/llm/maps');
  if (maps) {
    const sel = document.getElementById('map-select');
    const current = sel.value;
    sel.innerHTML = maps.map(m => `<option value="${m}" ${m === currentMapKey ? 'selected' : ''}>${m}</option>`).join('');
  }

  // Load selected map
  const selectedMap = document.getElementById('map-select').value || currentMapKey;
  if (selectedMap) {
    const mapData = await fetchJSON(`/llm/maps/${selectedMap}`);
    if (mapData) {
      document.getElementById('traversal-map').innerHTML = renderTraversalMap(mapData);
      document.getElementById('tile-map').innerHTML = renderTileMap(mapData);
    }
  }

  const connections = await fetchJSON('/llm/connections');
  if (connections) {
    document.getElementById('connections-list').innerHTML = renderConnections(connections);
  }
}

document.getElementById('map-select').addEventListener('change', async (e) => {
  currentMapKey = e.target.value;
  const mapData = await fetchJSON(`/llm/maps/${currentMapKey}`);
  if (mapData) {
    document.getElementById('traversal-map').innerHTML = renderTraversalMap(mapData);
    document.getElementById('tile-map').innerHTML = renderTileMap(mapData);
  }
});

refresh();
setInterval(refresh, POLL_MS);
</script>
</body>
</html>
